<!DOCTYPE html>
<html lang="en">

<head>
    <title>Getting Started with ml5.js</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- p5 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/addons/p5.sound.min.js"></script>
    <!-- ml5 -->
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <!-- 5.rec -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.js"></script>
    <script type="module" src="https://unpkg.com/p5.rec"></script>

</head>

<body>
    <script>
        // Your code will go here
        // open up your console - if everything loaded properly you should see the latest ml5 version
        console.log('ml5 version:', ml5.version);

        // function setup() {
        //     createCanvas(1000, 1000);
        // }

        // function draw() {
        //     background(200);
        // }



        // ml5.js: Pose Estimation with PoseNet
        // The Coding Train / Daniel Shiffman
        // https://thecodingtrain.com/Courses/ml5-beginners-guide/7.1-posenet.html
        // https://youtu.be/OIo-DIOkNVg
        // https://editor.p5js.org/codingtrain/sketches/ULA97pJXR

        let video;
        let poseNet;
        // let pose;
        // let skeleton;
        let poses = [];
        // var num;
        let c;

        let saveIt = false;

        function setup() {
            c = createCanvas(windowWidth, windowHeight);
            // createCanvas(640, 480);
            video = createCapture(VIDEO);
            video.elt.setAttribute('playsinline', '');
            video.hide();
            poseNet = ml5.poseNet(video, "multiple", modelLoaded);
            poseNet.on('pose', function (results) {
                poses = results;
                console.log(poses)
            });
        };

        function modelLoaded() {
            console.log('poseNet ready');
        };

        // function zoom(x, y) {
        //     var coef_x = windowWidth / 640;
        //     var coef_y = windowHeight / 480;
        //     x *= coef_x;
        //     y *= coef_y;

        // }

        function draw() {
            push();
            translate(width, 0);
            scale(-1, 1);
            image(video, 0, 0, width, height);
            var coef_x = windowWidth / 640;
            var coef_y = windowHeight / 480;
            if (poses) {
                for (var j = 0; j < poses.length; j++) {
                    var pose = poses[j].pose;
                    var skeleton = poses[j].skeleton;
                    let eyeR = pose.rightEye;
                    let eyeL = pose.leftEye;
                    let d = dist(eyeR.x * coef_x, eyeR.y * coef_y, eyeL.x * coef_x, eyeL.y * coef_y);
                    fill(255, 0, 0);
                    ellipse(pose.nose.x * coef_x, pose.nose.y * coef_y, d);
                    fill(0, 0, 255);
                    ellipse(pose.rightWrist.x * coef_x, pose.rightWrist.y * coef_y, 32);
                    ellipse(pose.leftWrist.x * coef_x, pose.leftWrist.y * coef_y, 32);

                    for (let i = 0; i < pose.keypoints.length; i++) {
                        let x = pose.keypoints[i].position.x * coef_x;
                        let y = pose.keypoints[i].position.y * coef_y;
                        fill(0, 255, 0);
                        ellipse(x, y, 16, 16);
                    }

                    for (let i = 0; i < skeleton.length; i++) {
                        let a = skeleton[i][0];
                        let b = skeleton[i][1];
                        strokeWeight(2);
                        stroke(255);
                        line(a.position.x * coef_x, a.position.y * coef_y, b.position.x * coef_x, b.position.y * coef_y);
                    }
                }

            }

            // if (key == 's') {
            //     saveIt = true;
            //     startRecording();
            // }
            // if (key == 'q') {
            //     saveIt = false;
            //     stopRecording();
            // }
            // if (saveIt) {
            //     saveFrames('./video_data/record', 'jpg', 1, 25, data => {
            //         console.log("record running...");
            //         console.log(data);
            //     });
            // }
            pop();

        };
    </script>
</body>

</html>